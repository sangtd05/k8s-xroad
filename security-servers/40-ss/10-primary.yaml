apiVersion: v1
kind: Service
metadata:
  name: ss-primary
  namespace: xroad
spec:
  clusterIP: None
  selector: { app: ss-primary }
  ports:
    - name: ssh-sync
      port: 22
      targetPort: 22
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ss-primary
  namespace: xroad
spec:
  replicas: 1
  selector: { matchLabels: { app: ss-primary } }
  template:
    metadata: { labels: { app: ss-primary } }
    spec:
      # Pin to k8s-worker-1 by hostname or label; change selector to match your node
      nodeSelector:
        kubernetes.io/hostname: k8s-worker-1
      containers:
        - name: sidecar
          image: niis/xroad-security-server-sidecar:7.6.2-primary
          imagePullPolicy: IfNotPresent
          envFrom:
            - secretRef: { name: xroad-secrets }
          ports:
            - { containerPort: 4000, name: admin }
            - { containerPort: 5588, name: health }
            - { containerPort: 22,    name: ssh }
          volumeMounts:
            - { name: etc-xroad, mountPath: /etc/xroad }
            - { name: var-xroad, mountPath: /var/lib/xroad }
            - { name: db-props,  mountPath: /etc/xroad/db.properties, subPath: db.properties }
          resources:
            requests: { cpu: "1000m", memory: "3Gi" }
            limits:   { cpu: "2000m", memory: "4Gi" }
          readinessProbe:
            httpGet: { path: "/", port: 5588 }
            initialDelaySeconds: 30
            periodSeconds: 10
          livenessProbe:
            httpGet: { path: "/", port: 5588 }
            initialDelaySeconds: 60
            periodSeconds: 20
      volumes:
        - { name: etc-xroad, persistentVolumeClaim: { claimName: etc-xroad-primary-pvc } }
        - { name: var-xroad, persistentVolumeClaim: { claimName: var-xroad-primary-pvc } }
        - { name: db-props,  secret: { secretName: xroad-db-properties } }
